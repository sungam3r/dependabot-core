#!/bin/bash

set -e
cd "$(dirname "$0")/.."
source script/_common

HELP=false
REBUILD=false

# Enable docker buildkit with inline cache builds
export DOCKER_BUILDKIT=1

# shellcheck disable=SC2034
OPTS=$(getopt -o hr --long help,rebuild -n 'parse-options' -- "$@")
# shellcheck disable=SC2181
if [ $? != 0 ]; then
  echo "failed parsing options" >&2
  exit 1
fi

if [[ -z "$1" ]]; then
  HELP=true
fi

# Technically every ecosystem results in building a per-ecosystem updater image.
# But currently running the `updater` unit tests requires the `bundler` ecosystem image.
if [ "$1" == "updater" ]; then
  ECOSYSTEM="bundler"
else
  ECOSYSTEM="$1"
fi

while true; do
  case "$2" in
    -h | --help ) HELP=true; shift ;;
    -r | --rebuild ) REBUILD=true; shift ;;
    -- ) shift; break ;;
    * ) break ;;
  esac
done

IMAGE_NAME="dependabot/dependabot-core-development-$ECOSYSTEM"
CONTAINER_NAME="dependabot-core-development-$ECOSYSTEM"
DOCKERFILE="Dockerfile.development"

if [ "$HELP" = "true" ]; then
  echo "usage: $0 <ecosystem> [--rebuild] [ARGS]"
  exit 0
fi

build_image() {
  export BUILT_IMAGE=true
  echo "$(tput setaf 2)=> building image from Dockerfile$(tput sgr0)"

  DEPENDABOT_USER_UID=$(id -u)
  DEPENDABOT_USER_GID=$(id -g)
  export DEPENDABOT_USER_UID
  export DEPENDABOT_USER_GID
  docker_build "$ECOSYSTEM"

  echo "$(tput setaf 2)=> building image from $DOCKERFILE$(tput sgr0)"
  docker build \
    --build-arg BUILDKIT_INLINE_CACHE=1 \
    --build-arg "FROM_IMAGE=$UPDATER_IMAGE_NAME" \
    -t "$IMAGE_NAME" \
    -f "$DOCKERFILE" \
    .
}

IMAGE_ID=$(docker inspect --type=image -f '{{.Id}}' "$IMAGE_NAME" 2> /dev/null || true)
if [ -z "$IMAGE_ID" ]; then
  echo "$(tput setaf 4) > image $IMAGE_NAME doesn't exist$(tput sgr0)"
  build_image
elif [ "$REBUILD" = "true" ]; then
  echo "$(tput setaf 4) > rebuild of $IMAGE_NAME requested$(tput sgr0)"
  build_image
else
  echo "$(tput setaf 4) > image $IMAGE_NAME already exists$(tput sgr0)"
fi

set +e
RUNNING=$(docker ps --format '{{.Names}}' | grep "$CONTAINER_NAME$")
set -e
echo "$RUNNING"
if [ -n "$RUNNING" ]; then
  if [ -z "$BUILT_IMAGE" ]; then
    # image was not rebuilt - can we reuse existing?
    exec docker exec -ti "$CONTAINER_NAME" bash
  else
    # image was rebuilt - exit running container
    docker stop "$CONTAINER_NAME"
  fi
fi

DOCKER_OPTS=()
if [ -n "$DEPENDABOT_PROXY" ]; then
  DOCKER_OPTS+=(-e "http_proxy=$DEPENDABOT_PROXY")
  DOCKER_OPTS+=(-e "HTTP_PROXY=$DEPENDABOT_PROXY")
  DOCKER_OPTS+=(-e "https_proxy=$DEPENDABOT_PROXY")
  DOCKER_OPTS+=(-e "HTTPS_PROXY=$DEPENDABOT_PROXY")
fi

if [ -n "$DOCKER_NETWORK" ]; then
  DOCKER_OPTS+=(--network "$DOCKER_NETWORK")
fi

CONTAINER_ARGS=("bash")
if [ "$#" -gt "1" ]; then
  CONTAINER_ARGS=("${@:2}")
fi

echo "$(tput setaf 2)=> running docker development shell$(tput sgr0)"
CODE_DIR="/home/dependabot"
touch .core-bash_history
mkdir -p dry-run tmp
docker run --rm -ti \
  -v "$(pwd)/.core-bash_history:/home/dependabot/.bash_history" \
  -v "$(pwd)/.rubocop.yml:$CODE_DIR/.rubocop.yml" \
  -v "$(pwd)/.ruby-version:$CODE_DIR/.ruby-version" \
  -v "$(pwd)/bin:$CODE_DIR/bin" \
  -v "$(pwd)/bundler:$CODE_DIR/bundler" \
  -v "$(pwd)/cargo:$CODE_DIR/cargo" \
  -v "$(pwd)/common:$CODE_DIR/common" \
  -v "$(pwd)/composer:$CODE_DIR/composer" \
  -v "$(pwd)/docker:$CODE_DIR/docker" \
  -v "$(pwd)/elm:$CODE_DIR/elm" \
  -v "$(pwd)/git_submodules:$CODE_DIR/git_submodules" \
  -v "$(pwd)/dry-run:$CODE_DIR/dry-run" \
  -v "$(pwd)/github_actions:$CODE_DIR/github_actions" \
  -v "$(pwd)/go_modules:$CODE_DIR/go_modules" \
  -v "$(pwd)/gradle:$CODE_DIR/gradle" \
  -v "$(pwd)/hex:$CODE_DIR/hex" \
  -v "$(pwd)/maven:$CODE_DIR/maven" \
  -v "$(pwd)/npm_and_yarn:$CODE_DIR/npm_and_yarn" \
  -v "$(pwd)/nuget:$CODE_DIR/nuget" \
  -v "$(pwd)/omnibus:$CODE_DIR/omnibus" \
  -v "$(pwd)/pub:$CODE_DIR/pub" \
  -v "$(pwd)/python:$CODE_DIR/python" \
  -v "$(pwd)/swift:$CODE_DIR/swift" \
  -v "$(pwd)/terraform:$CODE_DIR/terraform" \
  -v "$(pwd)/tmp:/$CODE_DIR/tmp" \
  -v "$(pwd)/updater:$CODE_DIR/dependabot-updater" \
  --name "$CONTAINER_NAME" \
  --env "LOCAL_GITHUB_ACCESS_TOKEN=$LOCAL_GITHUB_ACCESS_TOKEN" \
  --env "DEPENDABOT_TEST_ACCESS_TOKEN" \
  "${DOCKER_OPTS[@]}" \
  --cap-add=SYS_PTRACE \
  "$IMAGE_NAME" "${CONTAINER_ARGS[@]}"
